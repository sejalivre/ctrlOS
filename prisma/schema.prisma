generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  TECHNICIAN
  RECEPTIONIST
}

enum OSStatus {
  OPENED
  IN_QUEUE
  IN_PROGRESS
  AWAITING_PARTS
  READY
  DELIVERED
  CANCELLED
  WARRANTY_RETURN
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  CHECK
  OTHER
}

model User {
  id            String         @id @default(cuid())
  authId        String         @unique
  name          String
  email         String         @unique
  role          Role           @default(TECHNICIAN)
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  serviceOrders ServiceOrder[]
  sales         Sale[]
  financialRecords FinancialRecord[]

  @@index([email])
  @@index([role])
}

model Customer {
  id           String         @id @default(cuid())
  name         String
  phone        String?
  email        String?
  document     String?
  address      String?
  neighborhood String?
  city         String?
  state        String?
  zipCode      String?
  notes        String?
  active       Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  serviceOrders ServiceOrder[]
  budgets      Budget[]
  sales        Sale[]
  financialRecords FinancialRecord[]

  @@index([name])
  @@index([phone])
  @@index([email])
}

model Product {
  id           String             @id @default(cuid())
  code         String             @unique @default(uuid())
  name         String
  description  String?
  supplierId   String?
  costPrice    Float              @default(0)
  salePrice    Float              @default(0)
  profitMargin Float?             @default(0)
  stockQty     Int                @default(0)
  minStock     Int                @default(5)
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  budgetItems  BudgetItem[]
  supplier     Supplier?          @relation(fields: [supplierId], references: [id])
  saleItems    SaleItem[]
  orderItems   ServiceOrderItem[]

  @@index([name])
  @@index([stockQty])
}

model Service {
  id           String             @id @default(cuid())
  code         String             @unique @default(uuid())
  name         String
  description  String?
  defaultPrice Float              @default(0)
  duration     Int?
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  budgetItems  BudgetItem[]
  saleItems    SaleItem[]
  orderItems   ServiceOrderItem[]
}

model Supplier {
  id        String    @id @default(cuid())
  name      String
  phone     String?
  email     String?
  document  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model ServiceOrder {
  id                String             @id @default(cuid())
  orderNumber       Int                @unique
  customerId        String
  technicianId      String?
  status            OSStatus           @default(OPENED)
  priority          Priority           @default(NORMAL)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  promisedDate      DateTime?
  completedAt       DateTime?
  deliveredAt       DateTime?
  totalAmount       Float              @default(0)
  warrantyTerms     String?            @db.Text
  productsAmount    Float              @default(0)
  servicesAmount    Float              @default(0)
  freightAmount     Float              @default(0)
  othersAmount      Float              @default(0)
  discountAmount    Float              @default(0)
  paymentMethod     PaymentMethod?
  paid              Boolean            @default(false)
  paidAt            DateTime?
  entryQueue        Int?
  entryPhotos       String?
  exitPhotos        String?
  customerSignature String?
  equipments        Equipment[]
  financialRecords  FinancialRecord[]
  customer          Customer           @relation(fields: [customerId], references: [id])
  technician        User?              @relation(fields: [technicianId], references: [id])
  items             ServiceOrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@index([technicianId])
}

model Equipment {
  id              String       @id @default(cuid())
  serviceOrderId  String
  type            String
  brand           String?
  model           String?
  serialNumber    String?
  reportedIssue   String
  diagnosis       String?
  solution        String?
  warrantyDays    Int?         @default(30)
  warrantyExpires DateTime?
  accessories     String?
  observations    String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  serviceOrder    ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId])
}

model ServiceOrderItem {
  id             String       @id @default(cuid())
  serviceOrderId String
  productId      String?
  serviceId      String?
  description    String
  quantity       Int          @default(1)
  unitPrice      Float        @default(0)
  discount       Float        @default(0)
  totalPrice     Float        @default(0)
  createdAt      DateTime     @default(now())
  product        Product?     @relation(fields: [productId], references: [id])
  service        Service?     @relation(fields: [serviceId], references: [id])
  serviceOrder   ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId])
}

model Budget {
  id              String       @id @default(cuid())
  budgetNumber    String       @unique
  customerId      String
  status          BudgetStatus @default(PENDING)
  validUntil      DateTime
  totalAmount     Float        @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  customer        Customer     @relation(fields: [customerId], references: [id])
  items           BudgetItem[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

enum BudgetStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CONVERTED
}

model BudgetItem {
  id        String   @id @default(cuid())
  budgetId  String
  productId String?
  serviceId String?
  description String
  quantity  Int      @default(1)
  unitPrice Float    @default(0)
  discount  Float    @default(0)
  totalPrice Float   @default(0)
  createdAt DateTime @default(now())
  product   Product? @relation(fields: [productId], references: [id])
  service   Service? @relation(fields: [serviceId], references: [id])
  budget    Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
}

model Sale {
  id           String    @id @default(cuid())
  saleNumber   String    @unique
  customerId   String
  sellerId     String
  totalAmount  Float     @default(0)
  warrantyTerms String?  @db.Text
  paymentMethod PaymentMethod?
  paid         Boolean   @default(false)
  paidAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  customer     Customer  @relation(fields: [customerId], references: [id])
  seller       User      @relation(fields: [sellerId], references: [id])
  items        SaleItem[]
  financialRecords FinancialRecord[]

  @@index([customerId])
  @@index([sellerId])
  @@index([createdAt])
}

model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  productId String?
  serviceId String?
  description String
  quantity  Int      @default(1)
  unitPrice Float    @default(0)
  discount  Float    @default(0)
  totalPrice Float   @default(0)
  createdAt DateTime @default(now())
  product   Product? @relation(fields: [productId], references: [id])
  service   Service? @relation(fields: [serviceId], references: [id])
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model FinancialRecord {
  id          String        @id @default(cuid())
  type        FinancialType
  customerId  String?
  userId      String?
  serviceOrderId String?
  saleId      String?
  description String
  category    String?
  amount      Float         @default(0)
  paymentMethod PaymentMethod?
  paid        Boolean       @default(false)
  paidAt      DateTime?
  dueDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  customer    Customer?     @relation(fields: [customerId], references: [id])
  user        User?         @relation(fields: [userId], references: [id])
  serviceOrder ServiceOrder? @relation(fields: [serviceOrderId], references: [id])
  sale        Sale?         @relation(fields: [saleId], references: [id])

  @@index([type])
  @@index([customerId])
  @@index([userId])
  @@index([createdAt])
}

enum FinancialType {
  REVENUE
  EXPENSE
  INVESTMENT
  LOAN
}

model SystemSettings {
  id              String  @id @default("global")
  companyName     String? @default("CtrlOS - Assistência Técnica")
  companyLogo     String?
  companyPhone    String?
  companyEmail    String?
  companyAddress  String?
  companyDocument String?
  currency        String? @default("BRL")
  footerText      String? @default("CtrlOS © 2024 - Sistema de Gestão para Assistências Técnicas")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
model WarrantyTerm {
  id        String   @id @default(cuid())
  name      String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

